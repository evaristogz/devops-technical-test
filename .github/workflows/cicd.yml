name: Azure E-commerce CI/CD Pipeline
# TEST para ejecuciÃ³n workflow
on:
  # TODO: Configure triggers
  # - Push to main and develop branches
  # - Pull requests to main
  # - Manual workflow dispatch with environment selection
  
  push:
    branches: [main, solucion-evaristogz] # UsarÃ© solucion-evaristogz por simplificar
    paths-ignore:
      - 'docs/**'
      - '*.md'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging  
        - prod

env:
  # TODO: Configure environment variables
  AZURE_CONTAINER_REGISTRY: ${{ vars.AZURE_CONTAINER_REGISTRY }}
  AKS_CLUSTER_NAME: ${{ vars.AKS_CLUSTER_NAME }}
  AKS_RESOURCE_GROUP: ${{ vars.AKS_RESOURCE_GROUP }}
  HELM_CHART_PATH: ${{ vars.HELM_CHART_PATH }}

# TODO: Configure permissions for OIDC
permissions:
  id-token: write
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # TODO: Job 1 - Infrastructure Validation
  validate-infrastructure:
    runs-on: ubuntu-latest
    name: Validate Terraform Infrastructure
    steps:
      # TODO: Implement steps:
      # - Checkout code
      - name: Checkout code
        uses: actions/checkout@v6
      
      # - Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
      
      # - Azure login with OIDC
      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      # - Terraform init, validate, and plan
      - name: Terraform Init
        working-directory: ./infrastructure
        run: terraform init
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
      
      - name: Terraform Validate
        working-directory: ./infrastructure
        run: terraform validate
      
      - name: Terraform Plan
        id: plan
        working-directory: ./infrastructure
        run: |
          terraform plan -out=tfplan -no-color
          terraform show -no-color tfplan > plan_output.txt
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        continue-on-error: true
      
      # - Security scan with tfsec
      - name: Run tfsec Security Scan
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: ./infrastructure
          soft_fail: true
          additional_args: --format sarif --out tfsec-results.sarif
      
      - name: Upload tfsec SARIF results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('tfsec-results.sarif') != ''
        with:
          sarif_file: tfsec-results.sarif
          category: tfsec
      
      # - Comment on PR with plan results
      - name: Comment PR with Terraform Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        env:
          PLAN_OUTPUT: ${{ steps.plan.outputs.stdout }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('./infrastructure/plan_output.txt', 'utf8');
            const output = `#### Terraform Plan ðŸ“‹
            
            <details><summary>Show Plan</summary>
            
            \`\`\`terraform
            ${planOutput}
            \`\`\`
            
            </details>
            
            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
      
  # TODO: Job 2 - Build and Test
  build-and-test:
    runs-on: ubuntu-latest
    name: Build Application and Run Tests
    #needs: validate-infrastructure
    steps:
      # - Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # - Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # - Install dependencies
      - name: Install Backend Dependencies
        working-directory: ./src/backend
        run: npm ci
      
      - name: Install Frontend Dependencies
        working-directory: ./src/frontend
        run: npm ci
      
      # - Run linting
      - name: Lint Backend Code
        working-directory: ./src/backend
        run: npm run lint || echo "Linting not configured, skipping"
        continue-on-error: true
      
      - name: Lint Frontend Code
        working-directory: ./src/frontend
        run: npm run lint || echo "Linting not configured, skipping"
        continue-on-error: true
      
      # - Run unit tests with coverage
      - name: Run Backend Tests
        working-directory: ./src/backend
        run: npm run test:coverage
      
      - name: Run Frontend Tests
        working-directory: ./src/frontend
        run: npm run test:coverage
      
      # Upload coverage reports
      - name: Upload Backend Coverage
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: backend-coverage
          path: src/backend/coverage/
          retention-days: 30
      
      - name: Upload Frontend Coverage
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: frontend-coverage
          path: src/frontend/coverage/
          retention-days: 30
      
      # TODO: SonarCloud analysis (optional)
      
  # TODO: Job 3 - Build and Push Docker Images  
  build-images:
    runs-on: ubuntu-latest
    name: Build and Push Docker Images
    needs: build-and-test
    outputs:
      frontend-digest: ${{ steps.build-frontend.outputs.digest }}
      backend-digest: ${{ steps.build-backend.outputs.digest }}
      frontend-tag: ${{ steps.meta-frontend.outputs.tags }}
      backend-tag: ${{ steps.meta-backend.outputs.tags }}
    steps:
      # - Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # - Azure login with OIDC
      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      # - Login to ACR
      - name: Login to Azure Container Registry
        run: az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}
      
      # - Setup Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # - Generate metadata for images
      - name: Docker meta - Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.AZURE_CONTAINER_REGISTRY }}/ecommerce-frontend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Docker meta - Backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.AZURE_CONTAINER_REGISTRY }}/ecommerce-backend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      # - Build and push frontend image
      - name: Build and Push Frontend Image
        id: build-frontend
        uses: docker/build-push-action@v5
        with:
          context: ./src/frontend
          file: ./src/frontend/dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
      
      # - Build and push backend image
      - name: Build and Push Backend Image
        id: build-backend
        uses: docker/build-push-action@v5
        with:
          context: ./src/backend
          file: ./src/backend/dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
      
      # - Generate image metadata summary
      - name: Image Build Summary
        run: |
          echo "## ðŸ³ Docker Images Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend Image" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags**: ${{ steps.meta-frontend.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest**: ${{ steps.build-frontend.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backend Image" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags**: ${{ steps.meta-backend.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest**: ${{ steps.build-backend.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
      
  # TODO: Job 4 - Security Scanning
  # security-scan:
  #   runs-on: ubuntu-latest
  #   name: Security Scanning
  #   needs: build-images
  #   steps:
  #     # TODO: Implement steps:
  #     # - Trivy container scanning
  #     # - Microsoft Defender for Containers
  #     # - Upload SARIF results
  #     # - Fail on high/critical vulnerabilities
      
  # TODO: Job 5 - Validate Kubernetes Manifests
  # validate-k8s:
  #   runs-on: ubuntu-latest  
  #   name: Validate Kubernetes Manifests
  #   steps:
  #     # TODO: Implement steps:
  #     # - Checkout code
  #     # - Validate YAML syntax with kubeval
  #     # - Security analysis with kube-score
  #     # - Policy validation with Conftest/OPA
      
  # TODO: Job 6 - Validate Helm Chart
  # validate-helm:
  #   runs-on: ubuntu-latest
  #   name: Validate Helm Chart
  #   steps:
  #     # TODO: Implement steps:
  #     # - Checkout code
  #     # - Setup Helm
  #     # - Helm dependency update
  #     # - Helm lint
  #     # - Helm template dry-run
  #     # - Test with different values files
      
  # TODO: Job 7 - Deploy to Development
  # deploy-dev:
  #   runs-on: ubuntu-latest
  #   name: Deploy to Development Environment
  #   needs: [security-scan, validate-k8s, validate-helm]
  #   if: github.ref == 'refs/heads/solucion-evaristogz'
  #   environment: development
  #   steps:
  #     # TODO: Implement steps:
  #     # - Checkout code
  #     # - Azure login with OIDC
  #     # - Get AKS credentials
  #     # - Setup Helm
  #     # - Deploy with Helm (dev values)
  #     # - Run smoke tests
  #     # - Update deployment status
      
  # TODO: Job 8 - Deploy to Staging  
  # deploy-staging:
  #   runs-on: ubuntu-latest
  #   name: Deploy to Staging Environment
  #   needs: [security-scan, validate-k8s, validate-helm]
  #   if: github.ref == 'refs/heads/main'
  #   environment: staging
  #   steps:
  #     # TODO: Implement steps:
  #     # - Similar to dev deployment but with staging values
  #     # - More comprehensive testing
  #     # - Performance testing (optional)
      
  # TODO: Job 9 - Deploy to Production (Blue-Green)
  # deploy-prod:
  #   runs-on: ubuntu-latest  
  #   name: Deploy to Production Environment
  #   needs: deploy-staging
  #   if: github.ref == 'refs/heads/main'
  #   environment: production
  #   steps:
  #     # TODO: Implement steps:
  #     # - Blue-green deployment strategy
  #     # - Health checks and validation
  #     # - Traffic switching
  #     # - Rollback on failure
  #     # - Notification to teams
      
  # TODO: Job 10 - Integration Tests
  # integration-tests:
  #   runs-on: ubuntu-latest
  #   name: Run Integration Tests  
  #   needs: deploy-dev
  #   if: github.ref == 'refs/heads/solucion-evaristogz'
  #   steps:
  #     # TODO: Implement steps:
  #     # - Run API integration tests
  #     # - Frontend E2E tests with Playwright/Cypress
  #     # - Database connectivity tests
  #     # - Generate test reports
      
  # TODO: Job 11 - Notification
  # notify:
  #   runs-on: ubuntu-latest
  #   name: Send Notifications
  #   needs: [deploy-dev, deploy-staging, deploy-prod]
  #   if: always()
  #   steps:
  #     # TODO: Implement steps:
  #     # - Teams/Slack notification
  #     # - Email notification on failure
  #     # - Update GitHub deployment status
      
  # TODO: Add reusable workflows or composite actions for common steps